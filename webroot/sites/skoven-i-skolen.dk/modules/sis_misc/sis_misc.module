<?php
/**
 * @file
 * Help functions.
 */


use Drupal\Core\Access\AccessResult;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\views\ViewExecutable;

/**
 * Implements hook_form_FORM_ID_alter().
 */
function sis_misc_form_editor_image_dialog_alter(&$form, FormStateInterface $form_state) {
  if (isset($form_state->getUserInput()['editor_object'])) {
    // By convention, the data that the text editor sends to any dialog is in
    // the 'editor_object' key. And the image dialog for text editors expects
    // that data to be the attributes for an <img> element.
    $image_element = $form_state->getUserInput()['editor_object'];
  }
  else {
    // Retrieve the image element's attributes from form state.
    $image_element = $form_state->get('image_element') ?: [];
  }

  $form['attributes']['data-image-size'] = [
    '#type' => 'select',
    '#options' => [
      'small' => t('Small'),
      'medium' => t('Medium'),
      'large' => t('Large'),
    ],
    '#title' => t('Image size'),
    '#default_value' => $image_element['data-image-size'] ?? ''
  ];
  $form['align']['#access'] = FALSE;
}

/**
 * Implements hook_entity_access().
 */
function sis_misc_entity_access(EntityInterface $entity, $operation, AccountInterface $account) {
  if ($entity->getEntityTypeId() === 'profile') {
    return AccessResult::allowedIfHasPermission($account, 'manage profile entities');
  }
}

/**
 * Implements hook_entity_access().
 */
function sis_misc_views_pre_render(ViewExecutable $view) {
  // Only doing this for the media library view.
  if ($view->id() === 'media_library') {
    $current_user = \Drupal::currentUser();
    $admin_roles = [
      'administrator',
      'editor',
      'webmaster',
    ];
    $is_admin = count(array_intersect($admin_roles, $current_user->getRoles()));
    $result = [];

    // If the user is non-admin, display only media authored by that user.
    if (!$is_admin) {
      foreach ($view->result as $key => $row) {
        $entity = $row->_entity;
        if ($entity->getOwnerId() == $current_user->id()) {
          $result[$key] = $row;
        }
      }
      $view->result = $result;
    }
  }
}

/**
 * Implements hook_form_alter().
 */
function sis_misc_form_entity_embed_dialog_alter(&$form, FormStateInterface $form_state) {
  $form['attributes']['data-entity-embed-display-settings']['image_style']['#access'] = \Drupal::currentUser()->hasPermission('administer media');
  $form['attributes']['data-entity-embed-display-settings']['image_loading']['#access'] = \Drupal::currentUser()->hasPermission('administer media');
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function sis_misc_form_node_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['options']['#access'] = \Drupal::currentUser()->hasPermission('bypass node access');

  $user = \Drupal::currentUser();
  $roles = $user->getRoles();

  $anonymous = array_intersect($roles, ['anonymous', 'organization', 'writer']);
  $logged_in = array_intersect($roles, ['administrator', 'editor', 'webmaster']);

  $form['field_list_media']['widget']['#required'] = !empty($logged_in);
  $form['field_list_media_anonymous']['widget'][0]['#required'] = !empty($anonymous);

  // Add custom markup that holds information about creation of dot on map for the end user.
  if ($form_id === 'node_dot_on_map_form') {
    if (isset($form['sis_map_address_dawa'])) {
      $form['sis_map_address_dawa']['#markup'] = '<div><p>For at få en prik på kortet, skal du enten skrive adresse eller lægge koordinater op for jeres sted. Du kan finde koordinaterne via Google Maps. Højreklik på stedet – og hent koordinater der.</p></div>';
    }
    if (isset($form['title'])) {
      $form['title']['#markup'] = '<div><p>Her kan du sætte en prik på kortet – indenfor forskellige kategorier. Du kan se de forskellige kategorier, hvis du går lidt længere ned.</p></div>';
    }
    $form['#markup'] = '<div><p>Her kan du oprette en prik for en institution, som hjælper udeskole lokalt.</p><ul><li>Vælg hvilken kategori din institution tilhører i "Kategorisering".</li><li>Beskriv din institution og dens tilbud til skoler i "Beskrivelse".</li><li>Sæt din institution på kortet i "Geolokation" ved at skrive adressen eller indtaste længe- og breddegrader.</li><li>De felter, som er markeret med * skal fyldes ud.</li></ul><p>&nbsp;</p></div>';
  }

  // Added form required fields for dot on the map content type depending on which fields are empty.
  if (in_array($form_id, array('node_dot_on_map_form', 'node_dot_on_map_edit_form'))) {
    $form['sis_map_address_dawa']['widget'][0]['#states'] = [
      'required' => [
        ':input[name="lon[0][value]"]' => ['filled' => false],
        'and',
        ':input[name="lat[0][value]"]' => ['filled' => false]
      ],
    ];
    $form['lon']['widget'][0]['value']['#states'] = [
      'required' => [
        ':input[name="lat[0][value]"]' => ['filled' => true],
        'and',
        ':input[name="lon[0][value]"]' => ['filled' => false]
      ],
    ];
    $form['lat']['widget'][0]['value']['#states'] = [
      'required' => [
        ':input[name="lon[0][value]"]' => ['filled' => true],
        'and',
        ':input[name="lat[0][value]"]' => ['filled' => false]
      ],
    ];
  }
}

/**
 * Implements hook_simple_sitemap_links_alter().
 */
function sis_misc_simple_sitemap_links_alter(array &$links) {
  foreach ($links as $key => $link) {
    $url = preg_replace('/^http:/', 'https:', $link['url']);
    $links[$key]['url'] = $url;
    // Fix the protocol for translation links in xml sitemap.
    foreach ($link['alternate_urls'] as $language => $alternate_url) {
      $alternate_url = preg_replace('/^http:/', 'https:', $alternate_url);
      $links[$key]['alternate_urls'][$language] = $alternate_url;
    }
  }
}
